sTenantMsbStatusUnknown()&&this.isLastEnabledTimeValid()}hasBeenMsbUser(){return this.isTenantMsbEnabled()||n.config.msbUseCachedMsbState&&this.isLastEnabledTimeValid()}isLastEnabledTimeValid(){if(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.lastAadEnabledTimeValid)return!0;const t=n.getCurrentTime()-n.MsbStateExpiryTimeInMs;return typeof this.lastMsbEnabledTime=="number"&&this.lastMsbEnabledTime>t}setLastMsbEnabledTime(n){this.lastMsbEnabledTime=n}getLastMsbEnabledTime(){return this.lastMsbEnabledTime}getTenantMsbStatus(){return this.tenantMsbStatus}isTenantMsbEnabled(){return this.tenantMsbStatus===t.Enabled}isTenantMsbDisabled(){return this.tenantMsbStatus===t.Disabled}isTenantMsbStatusUnknown(){return this.tenantMsbStatus===t.Unknown}setTenantMsbEnabledStatus(){this.tenantMsbStatus=t.Enabled}setTenantMsbDisabledStatus(){this.tenantMsbStatus=t.Disabled;this.setIsMsbEduTenantEnabled(!1)}setTenantMsbUnknownStatus(){this.tenantMsbStatus=t.Unknown;this.setIsMsbEduTenantEnabled(!1)}getMsbTenantVariants(){return this.msbTenantVariants.join(",")}setMsbTenantVariants(n){this.msbTenantVariants=n}getIsMsbEduTenantEnabled(){return(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbEDUTenant)?this.isTenantMsbEnabled():this.isTenantMsbEnabled()&&this.isMsbEduTenantEnabled}setIsMsbEduTenantEnabled(n){this.isMsbEduTenantEnabled=n}setLocalTenantSettingState(t){const i=JSON.stringify(t);n.LightweightStorage.setItem(u,i)}cleanLocalTenantSettingState(){n.LightweightStorage.removeItem(u)}getLocalTenantSettingState(){const t=n.LightweightStorage.getItem(u);if(t)try{return JSON.parse(t)}catch(i){this.cleanLocalTenantSettingState()}return null}getStoredMsbTenantName(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.tenantDisplayName}getStoredMsbIcon(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.iconLarge}getStoredMsbIconLargeIsDefault(){var n,t;return((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)===null||t===void 0?void 0:t.iconLargeIsDefault)||!1}getStoredMsbNavColor(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.navColor}getStoredMsbFontColor(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.fontColor}getStoredMsbIsEdu(){var n,t;return((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)===null||t===void 0?void 0:t.isEdu)||!1}getStoredMsbTenantVariants(){var n,t;return((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)===null||t===void 0?void 0:t.tenantVariants)||[]}getStoredMsbTenantGroup(){var n,t;if((t=(n=this.getLocalTenantSettingState())===null||n===void 0?void 0:n.tenantSettings)!==null&&t!==void 0)return t.tenantGroup}checkAndSetIsMsbInternalTenant(t){this.isMsbInternalTenant=n.config.msbInternalTenants&&!!t&&n.contains(n.config.msbInternalTenants,t)}getIsMsbInternalTenant(){var t;return!n.config.disableMsbInternalTenants&&(((t=this.getStoredMsbTenantGroup())===null||t===void 0?void 0:t.toLowerCase())==="msft"||this.isMsbInternalTenant)}getIsLightHouseTenant(){var n;return((n=this.getStoredMsbTenantGroup())===null||n===void 0?void 0:n.toLowerCase())==="lighthouse"}isGccTenant(){var n;return typeof BingAtWork=="undefined"?!1:!!((n=BingAtWork.wsb)===null||n===void 0?void 0:n.gccRegion)}isGccHighTenant(){var n;return typeof BingAtWork=="undefined"?!1:((n=BingAtWork.wsb)===null||n===void 0?void 0:n.gccRegion)===2}isMsbEnterpriseScopeEnabled(){return this.isWorkScopeApplicable(!0)}isWorkScopeZiPageContentEnabled(){return!n.config.msbWorkScopeZiPageContentDisabled&&(!n.config.useCobaltCSS||n.config.msbWorkScopeZiPageContentWin11Enabled)&&this.isWorkScopeApplicable(!0)&&!this.isEduTenant(!0)}isWorkMruEnabled(){return this.shouldForceEnterpriseAccount()&&!this.isEduTenant(!0)&&(!n.config.useCobaltCSS||n.config.msbWorkScopeZiPageContentWin11Enabled)}isEduMessagesCardEnabled(){return n.config.msbEduMessagesCardEnabled}isEduViewButtonEnabled(){return n.config.msbEduViewButtonEnabled}isWorkScopeApplicable(t){return(n.config.msbVerticalWorkScopeEnabled&&!this.isEduTenant(t)||this.isEduScopeApplicable(t))&&this.shouldForceEnterpriseAccount()&&!this.isGccTenant()}isEduScopeApplicable(t){return this.isEduTenant(t)&&n.config.msbWorkScopeEduEnabled}isEduTenant(n){return n?this.getStoredMsbIsEdu():this.getIsMsbEduTenantEnabled()}isMsbWorkScope(t,i){return this.isWorkScopeApplicable()&&(t===21||i==n.Scope.Work)}isMsbWorkScopeDsbRedirectEnabled(){return this.isWorkScopeApplicable()&&(n.config.msbWorkScopeDsbRedirectEnabled&&this.getIsMsbInternalTenant()||n.config.msbWorkScopeDsbRedirectEnabledWW)}isMsbWorkScopeSHRedirectEnabled(){return this.isWorkScopeApplicable()&&(n.config.msbEnableSearchHomeWSRedirect&&this.getIsMsbInternalTenant()||n.config.msbEnableSearchHomeWSRedirectWW)}isMsbWorkUpsellApplicable(){return(n.config.msbWorkScopeBannerIndicatorEnabledWW||n.config.msbWorkScopeBannerIndicatorEnabled&&this.getIsMsbInternalTenant())&&this.isWorkScopeApplicable()&&(!n.MockUrlParameters||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.showWorkUpsell))}isWorkScopeListViewEnabled(){return this.isWorkScopeApplicable()&&(n.config.msbWorkScopeListEnabledWW||n.config.msbWorkScopeListEnabled&&this.getIsMsbInternalTenant())}redirectScope(n){switch(n){case"RecommendedPeople":case"ExpandedOrgChart":return this.isMsbWorkScopeDsbRedirectEnabled()?"Work":"People";case"PopularSearchesFeedFallback":return this.isMsbWorkScopeDsbRedirectEnabled()?"Work":"Web";case"People":case"Bookmarks":return this.isMsbWorkScopeSHRedirectEnabled()?"Work":"People";case"MFIL":return"Documents";case"MPPL":case"MGRP":return"People";case"MBKS":return"Web";default:return undefined}}getMsbBrandUri(){var n;try{const t=(n=this.getStoredMsbIcon())!==null&&n!==void 0?n:"";if(t==="")return"";const i=atob(t),r=i.startsWith("<svg")||i.startsWith("<?xml"),u=r?"svg+xml":"jpeg";return`data:image/${u};base64,${t}`}catch(t){return""}}getMsbBranding(){try{const t=this.getMsbBrandUri(),i=this.getStoredMsbIconLargeIsDefault(),r=`#${this.getStoredMsbNavColor()}`,u=`#${this.getStoredMsbFontColor()}`,n=this.getStoredMsbTenantName();return t||n?{logoDataUri:t,iconLargeIsDefault:i,backColor:r,companyName:n!==null&&n!==void 0?n:"",fontColor:u}:undefined}catch(n){return undefined}}tenantHasLogo(){var n,t;const i=(n=this.getMsbBranding())===null||n===void 0?void 0:n.logoDataUri,r=(t=this.getMsbBranding())===null||t===void 0?void 0:t.iconLargeIsDefault;return!!(i&&!r)}checkTenantSettings(t,i,r,u){let f=t,e;n.msbPerfLogger&&(typeof this.lastPerfMarkCallId=="undefined"&&(this.lastPerfMarkCallId=0),e=this.lastPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsStarted,e),f=()=>{n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsReturned,e),t()});const o=n.getCurrentTime();this.shouldGetTenantSettings(o,u===null||u===void 0?void 0:u.RoutingHint)?this.checkTenantSettingsFromServer(f,n=>{this.checkTenantSettingsFromCache(f,()=>{(n===null||n===void 0?void 0:n.hasNativeIssue)||_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings Auth Fails and No Cached Results Available"),i(n)},r,u)},r,u,e):this.checkTenantSettingsFromCache(f,()=>{_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings No Cached Results Available"),i({})},r,u)}checkTenantSettingsFromCache(n,t,i,r){const u=this.getLocalTenantSetting();u?(this.updateTenantFlags(u,r,i),n()):(this.cleanLocalTenantSettingState(),t({}))}checkTenantSettingsFromServer(t,i,r,u,f){if(!this.fetchingTenant){this.fetchingTenant=!0;const h=(h,c)=>{var l,a,v,y;if(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsResponded,f),h===null||h===void 0?void 0:h.tenantSettings){const i={tenantId:h.tenantSettings.id,isEnabled:h.tenantSettings.isEnabled,isEdu:((l=h.tenantSettings.variants)===null||l===void 0?void 0:l.indexOf("Edu"))>=0,tenantVariants:(a=h.tenantSettings.variants)===null||a===void 0?void 0:a.filter(n=>e(n)),tenantDisplayName:h.tenantSettings.tenantDisplayName,iconLarge:h.tenantSettings.iconLargeIsDefault?"":h.tenantSettings.iconLarge,iconLargeIsDefault:h.tenantSettings.iconLargeIsDefault,navColor:((v=h.tenantSettings.themeColors)===null||v===void 0?void 0:v[1])||o,fontColor:((y=h.tenantSettings.themeColors)===null||y===void 0?void 0:y[2])||s,tenantGroup:h.tenantSettings.tenantGroup},f=n.getCurrentTime(),c=h.tenantSettings.isEnabled?f:undefined;this.updateTenantFlags(i,u,r);this.setLastMsbEnabledTime(c);this.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,200,f,c,i);this.fetchingTenant=!1;t()}else{const n=`Response: ${JSON.stringify(h)}`;const t=this.getIsMsbInternalTenant()?n:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Empty Tenant Settings","",{serverTraceId:c,statusCode:200,additionalMessage:t},{caller:r});this.fetchingTenant=!1;i({})}},c=(f,e)=>{const c=`[MSB.Error] checkTenantSettings: onError: ${JSON.stringify({statusCode:f,ajaxErrorInfo:e})}`;const o=f===404,s=f===401||f===403,l=f===-1,h=n.getCurrentTime();if(o)this.handleMsbDisable(),this.setLastMsbEnabledTime(undefined),this.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,404,h,undefined,{tenantId:"",isEnabled:!1,tenantDisplayName:"",iconLarge:"",iconLargeIsDefault:!1,navColor:"",fontColor:"",isEdu:!1,tenantVariants:[],tenantGroup:""});else{const n=this.getLocalTenantSettingState();this.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,f,h,n===null||n===void 0?void 0:n.lastMsbEnabledTimestamp,n===null||n===void 0?void 0:n.tenantSettings)}if(f!==n.ClientErrorCode.MsbTokenExpiredBeforeRequest||n.config.msbLogTokenExpiredBeforeRequest){const i=o?"Wsb Fetch Tenant Settings Non MSB":"Wsb Fetch Tenant Settings Failed",{message:u,errorMessage:h,responseText:c,stackTrace:l,serverTraceId:a,requestSentTime:v,responseReceivedTime:y,isBrowserOnline:p,hResultString:w}=e,t=this.getIsMsbInternalTenant()?`ResponseText: ${c}, ErrorMessages: ${h}`:"",b=s?`${t}, token=${JSON.stringify(n.getReducedTokenInfo(BingAtWork.wsb.wsbAccessToken))}`:t,k=this.getIsMsbInternalTenant()?l:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(i,u,{stackTrace:k,serverTraceId:a,statusCode:f,additionalMessage:b},{caller:r,Online:p,HResult:w,ReqTS:v,ResTS:y})}this.fetchingTenant=!1;o?t():i({hasTokenIssue:s,hasNativeIssue:l})};n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.TenantSettingsRequested,f);n.msbHost.dataAccess.getTenantSetting(h,c)}}updateTenantSettingStateCache(n,t,i,r,u){const f=this.getLocalTenantSettingState(),o=(f===null||f===void 0?void 0:f.failedTimes)||0;let e=o+1;(t===200||t===404||t==-1)&&(e=0);const s=this.getNextIntervalWaitTime(t,e),h={lastMsbEnabledTimestamp:r,lastTimestamp:i,nextRequestIntervalInMinutes:s,failedTimes:e,routingHint:n,tenantSettings:u};this.setLocalTenantSettingState(h)}shouldGetTenantSettings(n,t){const i=this.getLocalTenantSettingState();let r=!0;if(i){const{lastTimestamp:u,nextRequestIntervalInMinutes:f,routingHint:e}=i;t===e&&(r=n>u+f*6e4)}return r}handleMsbDisable(){this.setTenantMsbDisabledStatus();this.tenantDisabledHandlers&&this.tenantDisabledHandlers.forEach(t=>{n.safeExecute(()=>t(),"MsbTenantManager::fireTenantDisabled")})}getLocalTenantSetting(){const n=this.getLocalTenantSettingState();if(n!==null&&n!==void 0)return n.tenantSettings}updateTenantFlags(t,i,r){const{isEnabled:u,isEdu:f,tenantVariants:e}=t;u?(this.setTenantMsbEnabledStatus(),this.setIsMsbEduTenantEnabled(f),this.setMsbTenantVariants(e),this.tenantEnabledHandlers&&this.tenantEnabledHandlers.forEach(t=>{n.safeExecute(()=>t(i===null||i===void 0?void 0:i.RoutingHint,r),"MsbTenantManager::fireTenantEnabled")})):this.handleMsbDisable()}getNextIntervalWaitTime(t,u){let f=0;if(t===200||t===404)f=n.getRandomNumInRange(i,r);else if(u<=n.config.msbTenantSettingRetryNoWaitFailedTimes||t==-1)f=0;else{const e=(u-n.config.msbTenantSettingRetryNoWaitFailedTimes)*n.config.msbTenantSettingRetryInMin;f=t==503||t==429?f+e*3:f+e*4;f>=i+r&&(f=n.getRandomNumInRange(i,r))}return f}}n.MsbTenantManager=h}(WSB||(WSB={})),function(n){const f=21600,e=10080,t=1440,i=360,r="MsbUserConfig",u=1,o=4;class s{constructor(t,i){this.msbTokenManager=t;this.msbTenantManager=i;this.fetchingUserConfig=!1;n.Host.bindAccountChanged(()=>{this.cleanLocalUserConfigState(),this.setHasEduAssignmentsFlags(!1)});i.bindTenantEnabled(()=>{n.msbHost.isEduTenant()&&this.checkUserConfig(()=>{},()=>{},"MsbUserConfigManagerTenantEnabled",t.getMsbAccountRoutingHint())});t.bindTokenChanged(()=>{n.msbHost.isEduTenant()&&this.checkUserConfig(()=>{},()=>{},"MsbUserConfigManagerTokenChanged",t.getMsbAccountRoutingHint())})}setHasEduAssignmentsFlags(n){this.hasEduAssignments=n}getHasEduAssignmentsFlags(){return this.hasEduAssignments}checkUserConfig(t,i,r,u){let e=t,f;n.msbPerfLogger&&(typeof this.lastPerfMarkCallId=="undefined"&&(this.lastPerfMarkCallId=0),f=this.lastPerfMarkCallId++,n.msbPerfLogger.mark(n.MsbPerfProbe.UserConfigStarted,f),e=()=>{n.msbPerfLogger.mark(n.MsbPerfProbe.UserConfigReturned,f),t()});const o=n.getCurrentTime();this.shouldGetUserConfigState(o,u)?this.checkUserConfigFromServer(e,n=>{(n===null||n===void 0?void 0:n.hasNativeIssue)||_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch User Config Auth Fails and No Cached Results Available"),i(n)},r,u,undefined):this.checkUserConfigFromCache(()=>undefined,()=>undefined,r,u)}shouldGetUserConfigState(n,t){const i=this.getLocalUserConfigState();let r=!0;if(i){const{lastTimestamp:u,nextRequestIntervalInMinutes:f,routingHint:e}=i;t===e&&(r=n>u+f*6e4)}return r}checkUserConfigFromCache(n,t){var i;const r=(i=this.getLocalUserConfigState())===null||i===void 0?void 0:i.userConfig;r?this.setHasEduAssignmentsFlags(r.hasAssignments):t({})}getUserConfigsRequest(){return{clientContext:{clientType:"Wsb"},requiredConfigs:["LicenseSettings","EduSettings"]}}checkUserConfigFromServer(t,i,r,u,f){if(!this.fetchingUserConfig){this.fetchingUserConfig=!0;const e=n.msbHost.urlUtils.getMsbUrl("v3/user/data/configs"),o={url:e,body:JSON.stringify(this.getUserConfigsRequest()),requestType:"POST",onSuccess:(e,o)=>{var s,h;if(n.msbPerfLogger===null||n.msbPerfLogger===void 0?void 0:n.msbPerfLogger.mark(n.MsbPerfProbe.UserConfigResponded,f),e===null||e===void 0?void 0:e.user){const i={id:e.user.id,hasAssignments:(s=e.eduSettings)===null||s===void 0?void 0:s.hasAssignments,hasClasses:(h=e.eduSettings)===null||h===void 0?void 0:h.hasClasses,LicenseNames:e.licenseSettings?e.licenseSettings.enabledLicenses:[]},r=n.getCurrentTime();this.setHasEduAssignmentsFlags(i===null||i===void 0?void 0:i.hasAssignments);this.updateUserConfigStateCache(u,200,r,r,i);this.fetchingUserConfig=!1;t()}else{const t=`Response: ${JSON.stringify(e)}`;const u=n.msbHost.isMsbInternalTenant()?t:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Empty User Config","",{serverTraceId:o,statusCode:200,additionalMessage:u},{caller:r});this.fetchingUserConfig=!1;i({})}},onError:(f,e)=>{const l=`[MSB.Error] checkUserConfig: onError: ${JSON.stringify({statusCode:f,ajaxErrorInfo:e})}`;const o=f===404,s=f===401||f===403,a=f===-1,h=n.getCurrentTime();if(o)this.updateUserConfigStateCache(u,404,h,undefined,{id:"",hasAssignments:!1,hasClasses:!1});else{const n=this.getLocalUserConfigState();this.updateUserConfigStateCache(u,f,h,n===null||n===void 0?void 0:n.lastMsbEnabledTimestamp,n===null||n===void 0?void 0:n.userConfig)}const v=o?"Wsb Fetch User Config Not found":"Wsb Fetch User Config Failed",{message:y,errorMessage:p,responseText:w,stackTrace:b,serverTraceId:k,requestSentTime:d,responseReceivedTime:g,isBrowserOnline:nt,hResultString:tt}=e,c=n.msbHost.isMsbInternalTenant()?`ResponseText: ${w}, ErrorMessages: ${p}`:"",it=s?`${c}, token=${JSON.stringify(n.getReducedTokenInfo(BingAtWork.wsb.wsbAccessToken))}`:c,rt=n.msbHost.isMsbInternalTenant()?b:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(v,y,{stackTrace:rt,serverTraceId:k,statusCode:f,additionalMessage:it},{caller:r,Online:nt,HResult:tt,ReqTS:d,ResTS:g});this.fetchingUserConfig=!1;o?t():i({hasTokenIssue:s,hasNativeIssue:a})}};n.Msb.sendAjax(o)}}updateUserConfigStateCache(t,i,u,f,e){var o;const s=this.getLocalUserConfigState(),c=(o=s===null||s===void 0?void 0:s.failedTimes)!==null&&o!==void 0?o:0;let h=c+1;(i===200||i===404||i==-1)&&(h=0);const l=this.getNextIntervalWaitTime(i,h),a={lastMsbEnabledTimestamp:f,lastTimestamp:u,nextRequestIntervalInMinutes:l,failedTimes:h,routingHint:t,userConfig:e};n.LightweightStorage.setItem(r,JSON.stringify(a))}getNextIntervalWaitTime(r,s){let h=0;if(r===200)h=n.getRandomNumInRange(f,e);else if(r===404)h=n.getRandomNumInRange(t,i);else if(s<=u||r==-1)h=0;else{const f=(s-u)*o;h=r==503||r==429?h+f*3:h+f*4;h>=t+i&&(h=n.getRandomNumInRange(t,i))}return h}cleanLocalUserConfigState(){n.LightweightStorage.removeItem(r)}getLocalUserConfigState(){const t=n.LightweightStorage.getItem(r);if(t)try{return JSON.parse(t)}catch(i){this.cleanLocalUserConfigState()}return null}}n.MsbUserConfigManager=s}(WSB||(WSB={})),function(n){var t;(function(t){function h(t,i){var f,e,o,s,h,v;const u=(n,i)=>{if(t.onError!=null)t.onError(n,i)};if(t==null||!t.url){u(n.ClientErrorCode.UrlUnavailable,{message:"MsbAjax.sendAjax: no url available for request, won't send the request."});return}let r;if(t.useToken==="WSB3S"){if(r=(e=(f=_w.BingAtWork)===null||f===void 0?void 0:f.wsb)===null||e===void 0?void 0:e.wsb3sAccessToken,!r){u(n.ClientErrorCode.NoToken,{message:"MsbAjax.sendAjax: no WSB/3S access token, won't send the request."});return}}else if(t.useToken==="WSBLoki"){if(r=(s=(o=_w.BingAtWork)===null||o===void 0?void 0:o.wsb)===null||s===void 0?void 0:s.wsbLokiAccessToken,!r){u(n.ClientErrorCode.NoMsbLokiAccessToken,{message:"MsbAjax.sendAjax: no WSB/Loki access token, won't send the request."});return}}else{if(r=(v=(h=_w.BingAtWork)===null||h===void 0?void 0:h.wsb)===null||v===void 0?void 0:v.wsbAccessToken,!r){u(n.ClientErrorCode.NoToken,{message:"MsbAjax.sendAjax: no WSB access token, won't send the request."});return}const t=c();if(t){u(n.ClientErrorCode.MsbTokenExpiredBeforeRequest,t);return}}t.url[0]==="/"&&(t.url=(_w==null?"":_w.location.origin)+t.url);n.config.msbUseXmlHttpRequest?a(t,r,u,i):l(t,r,u,i)}function c(){var i,r;const t=(i=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||i===void 0?void 0:i.wsbAccessTokenJwtExp;if(t){const i=n.getCurrentTime(),u=t-i;if(u<0){const n=(r=BingAtWork===null||BingAtWork===void 0?void 0:BingAtWork.wsb)===null||r===void 0?void 0:r.wsbAccessTokenRefreshTime,f=i-(n||0);return{message:`${"Wsb token expired before request"} {[MsbAjax].sendAjax}, rt=${n}, jwtExp=${t}, now=${i}`}}}return undefined}function l(t,i,r,e){let h=0;switch(t.requestType){case"POST":h=1;break;case"PUT":h=4}const c=SearchAppWrapper.CortanaApp,a=c.createStringMap(),s=c.createStringMap();n.config.msbSkipUserAgent||(s["User-Agent"]=navigator.userAgent);s.Authorization=`Bearer ${i}`;s.Accept="*/*";a["Content-Type"]="application/json";for(const n in t.headers)s[n]=t.headers[n];const v=performance.now(),l=new Date,o=l.getTime();n.Async.safeChain("makeHttpRequestAsync_MsbAjax_Ajax",()=>c.makeHttpRequestAsync(h,t.url,s,t.body||"",a),i=>{const h=n.getCurrentTime(),{serverTraceId:s,serverTime:c,serverLatency:a}=f(i===null||i===void 0?void 0:i.headers);if(u(t,c,o,s,"MsbAjax::sendCortanaAppHttpRequest"),t.onRoundTripReport){const n=i.statusCode==200?undefined:`HTTP${i.statusCode}`,r=performance.now(),u=new Date,f=i.statusCode;t.onRoundTripReport({startTime:v,endTime:r,startDateTime:l,endDateTime:u,serverLatency:a,errorMessage:n,status:f,traceId:s})}i.statusCode===200?n.Async.safeChain(`msbajax_ReadResponse`,()=>i.readAsStringAsync(),i=>{if(t.onSuccess!=null){let u=null;if(i!=="")try{u=e?i:JSON.parse(i)}catch(f){r(n.ClientErrorCode.ResponseJsonParseError,{message:"Bad data",responseText:i,serverTraceId:s,requestSentTime:o,responseReceivedTime:h});return}t.onSuccess(u,s)}},t=>{r(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_makeHttpRequestAsync_MsbAjax Error",errorMessage:`Name: ${t.name}, message: ${t.message}`,stackTrace:`${t.stack}`,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},undefined,undefined,0):n.Async.safeChain("readNon200Response",()=>i.readAsStringAsync(),n=>{r(i.statusCode,{message:`Ajax call failed with status ${i.statusCode.toString()}. No retries attempted.`,responseText:n,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},t=>{r(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_Non200_makeHttpRequestAsync_MsbAjax Error",errorMessage:`Name: ${t.name}, Message: ${t.message}`,stackTrace:`${t.stack}`,serverTraceId:s,requestSentTime:o,responseReceivedTime:h})},undefined,undefined,0)},i=>{if(t.onRoundTripReport){const i=`Promise error makeHttpRequestAsync_MsbAjax Error`,r=performance.now(),u=new Date,f=n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError;t.onRoundTripReport({startTime:v,endTime:r,startDateTime:l,endDateTime:u,errorMessage:i,status:f})}const{name:e,message:s,stack:c}=i,u={message:`Promise error makeHttpRequestAsync_MsbAjax Error`,errorMessage:`Name: ${e}, Message: ${s}, RequestType: ${h}, RequestUrl: ${t.url} `,stackTrace:`${c}`,requestSentTime:o,responseReceivedTime:n.getCurrentTime(),isBrowserOnline:navigator.onLine},f=i===null||i===void 0?void 0:i.number;typeof f=="number"&&(u.hResultString=n.formatHResultString(f));r(n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError,u)},undefined,undefined,0)}function a(t,i,r,s){const h={};h.Authorization=`Bearer ${i}`;h["Content-Type"]="application/json";for(const n in t.headers)h[n]=t.headers[n];const a=t.body||"",y=performance.now(),l=new Date,c=l.getTime(),w=i=>{var o;const h=n.getCurrentTime(),{serverTraceId:e,serverTime:a,serverLatency:w}=f(i===null||i===void 0?void 0:i.responseHeaders);if(u(t,a,c,e,"MsbAjax::sendXmlHttpRequest"),t.onRoundTripReport){const n=(i===null||i===void 0?void 0:i.status)==200?undefined:`HTTP${i===null||i===void 0?void 0:i.status}-RequestState${i===null||i===void 0?void 0:i.result}`,r=performance.now(),u=new Date,f=i.status;t.onRoundTripReport({startTime:y,endTime:r,startDateTime:l,endDateTime:u,serverLatency:w,errorMessage:n,status:f,traceId:e})}if((i===null||i===void 0?void 0:i.result)==0&&i.status==200){try{const n=s?i.responseText:JSON.parse(i.responseText);v(t);(o=t.onSuccess)===null||o===void 0?void 0:o.call(t,n,e)}catch(k){r(n.ClientErrorCode.ResponseJsonParseError,{message:"[MsbAjax]sendXmlHttpRequest Bad data",responseText:i.responseText,serverTraceId:e,requestSentTime:c,responseReceivedTime:h})}return}const b=(i===null||i===void 0?void 0:i.status)?i.status:p(i.result);r(b,{message:`[MsbAjax]sendXmlHttpRequest Error. ResponseStatus=${i===null||i===void 0?void 0:i.status}, ResultCode=${i.result}`,responseText:i===null||i===void 0?void 0:i.responseText,serverTraceId:e,requestSentTime:c,responseReceivedTime:h})};n.fetchUrl(t.url,h,a,w,undefined,undefined,undefined,o,undefined,t.requestType,e)}function u(t,i,r,u,f){if(n.config.msbServerClientTimeSkewLimitMins&&t.checkServerTime&&i){const e=i-r,o=`[${f}] returned, ServerTime=${i}, ClientTime=${r}, diff=${e}, urlBase=${n.msbHost.urlUtils.getUrlBaseInfo(t.url)}`,h=`Target URL: ${t.url}`;if(Math.abs(e)>n.config.msbServerClientTimeSkewLimitMins*s){const t=n.msbHost.isMsbInternalTenant()?h:undefined;bfbWsbTel.logError("Wsb server and client time mismatch",o,{serverTraceId:u,additionalMessage:t})}}}function v(n){const t=y(n.url);t&&bfbWsbTel.logValue("SuccessRequest",t)}function y(n){return n.indexOf("v2/tenant/my/settings")>-1?"v2/tenant/my/settings":n.indexOf("v3/user/token/Substrate")>-1?"v3/user/token/Substrate":n.indexOf("search/api/v2/query")>-1?"search/api/v2/query":undefined}function p(t){switch(t){case 2:return n.ClientErrorCode.Aborted;case 3:return n.ClientErrorCode.XhrError;case 1:return n.ClientErrorCode.TimedOut;default:return n.ClientErrorCode.XhrCompleted}}function f(t){const u=t===null||t===void 0?void 0:t[i],f=t===null||t===void 0?void 0:t[r];if(u||f)return{serverTraceId:u,serverLatency:f};const e=n.getMsEdgeRef(t),{traceId:o,timestamp:s}=e||{};return{serverTraceId:o,serverTime:s}}const i="request-id",r="x-end2endlatencyms",e=["x-msedge-ref",i,r],o=1e4,s=6e4;t.sendAjax=h})(t=n.Msb||(n.Msb={}))}(WSB||(WSB={})),function(n){class t{constructor(t,i,r){this.responseContext=t;this.errorMessage=i;this.innerError=r;this.isBrowserOnline=navigator.onLine;const u=r===null||r===void 0?void 0:r.number;t.statusCode===n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError&&typeof u=="number"&&(this.hResultString=n.formatHResultString(u))}}n.MsbHttpError=t;const i=6e4;class r{async sendHttpAsync(t){return this.validateRequest(t),this.validateTokenExpiry(t),n.config.msbDsbUseFetch||t.url.startsWith("http://localhost")?await this.fetchWrapperAsync(t):await this.makeHttpRequestWrapperAsync(t)}validateRequest(i){if(!i.url){const i=`[MsbHttpWrapper].sendHttpAsync failed with no url`;throw new t({statusCode:n.ClientErrorCode.UrlUnavailable},{publicMessage:i});}try{new URL(i.url)}catch(r){const u=`[MsbHttpWrapper].sendHttpAsync failed with ill-formed url`;throw new t({statusCode:n.ClientErrorCode.UrlUnavailable},{publicMessage:u,privateMessage:i.url},r);}if(!(i===null||i===void 0?void 0:i.token)){const i=`[MsbHttpWrapper].sendHttpAsync failed with no token.`;throw new t({statusCode:n.ClientErrorCode.NoToken},{publicMessage:i});}}async makeHttpRequestWrapperAsync(n){const r=this.buildMakeHttpRequestParameters(n),t=await this.callMakeHttpRequestApiAsync(r),{responseContext:i}=t;this.checkServerTime(n,i,"makeHttpRequestWrapperAsync");const u=await this.parseApiCallResultAsync(t,"makeHttpRequestWrapperAsync");return{responseContext:i,result:u}}buildMakeHttpRequestParameters(i){try{const{method:f,url:e,tok